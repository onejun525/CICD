name: Deploy to EC2 via Docker Compose

# ğŸ’¡ main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
on:
  push:
    branches:
      - main
      - master 

jobs:
  deploy:
    # ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  í™˜ê²½ (GitHub Runner)
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Docker Hub ë¡œê·¸ì¸ (ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker Hubì— í‘¸ì‹œí•˜ê¸° ìœ„í•¨)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
      # (CI/CD ì„œë²„ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ì—¬ Docker Hubì— ì €ì¥í•©ë‹ˆë‹¤.)
      - name: Build and Push Docker Images
        run: |
          # ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (FastAPI)
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/skn16-fastapi:latest-f Dockerfile .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/skn16-fastapi:latest
          
          # í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (Nginx)
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/skn16-frontend:latest ./frontend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/skn16-frontend:latest
        env:
          DOCKER_BUILDKIT: 1

      # 4. SSHë¥¼ ì‚¬ìš©í•˜ì—¬ EC2 ì„œë²„ì— ì ‘ì† ë° ë°°í¬ ëª…ë ¹ ì‹¤í–‰
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 5. EC2 ì„œë²„ì—ì„œ ì‹¤í–‰í•  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ë””ë ‰í† ë¦¬ ì´ë¦„ í™•ì¸ í•„ìˆ˜: SKN16-FINAL-4Team)
            cd SKN16-FINAL-4Team
            
            # Docker Hubì— ë‹¤ì‹œ ë¡œê·¸ì¸ (EC2ì—ì„œ pull ë°›ê¸° ìœ„í•¨)
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            
            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë° Docker Compose í™˜ê²½ ì¬ì‹œì‘
            # --pull always: Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ê°•ì œë¡œ ë‹¤ìš´ë¡œë“œ
            docker-compose pull
            
            # --no-build: ì´ë¯¸ Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ë°›ì•˜ìœ¼ë¯€ë¡œ EC2ì—ì„œ ë¹Œë“œ ìƒëµ
            docker-compose up -d --no-build
            
            # DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ìƒˆë¡œìš´ í…Œì´ë¸”/ì»¬ëŸ¼ ë°˜ì˜ ì‹œ)
            docker exec fastapi-prod python -m alembic upgrade head
